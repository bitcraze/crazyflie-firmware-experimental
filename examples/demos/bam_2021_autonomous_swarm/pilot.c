#include <float.h>
#include <math.h>

#include "FreeRTOS.h"
#include "timers.h"
#include "deck_digital.h"
#include "deck_constants.h"
#include "sensors.h"
#include "estimator_kalman.h"
#include "crtp_commander_high_level.h"
#include "commander.h"
#include "pm.h"
#include "stabilizer.h"
#include "ledseq.h"
#include "log.h"
#include "param.h"
#include "supervisor.h"
#include "controller.h"
#include "ledseq.h"
#include "pptraj.h"
#include "lighthouse_position_est.h"
#include "lighthouse_core.h"
#include "pilot.h"
#include "radiolink.h"
#include "protocol.h"

#define DEBUG_MODULE "PILOT"
#include "debug.h"



#define LED_LOCK         LED_GREEN_R
#define LOCK_LENGTH 50
#define LOCK_THRESHOLD 0.001f
#define MAX_PAD_ERR 0.005
#define TAKE_OFF_HEIGHT 0.2f
#define TAKE_OFF_TIME 1.0f
#define DURATION_TO_PAD_POSITION 2.0f
#define LANDING_HEIGHT 0.12f
#define LANDING_DURATION 1.0f
#define SEQUENCE_SPEED 1.0f
#define DURATION_TO_INITIAL_POSITION 2.0f

static uint32_t positionLockWriteIndex;
static float positionLockData[LOCK_LENGTH][3];
static void resetPositionLockData();
static bool hasPositionLock();

static uint32_t takeOffTime = 0;
static bool terminateTrajectoryAndLand = false;

static float padX = 0.0;
static float padY = 0.0;
static float padZ = 0.0;

static uint32_t landingTimeCheckCharge = 0;

static float stabilizeEndTime;

#define NO_PROGRESS -2000.0f
static uint32_t trajectoryStartTime = 0;
static float trajectoryDurationMs = 0.0f;

static float trajecory_center_offset_x = 0.0f;
static float trajecory_center_offset_y = 0.0f;
static float trajecory_center_offset_z = 0.0f;

static uint32_t now = 0;
static uint32_t flightTime = 0;

// The nr of trajectories to fly
static uint8_t trajectoryCount = 2;
static uint8_t remainingTrajectories = 0;

// Set to 1 to be active in the swarm. If 0 the CF is still
// part of the decision network.
static uint8_t isActive = 0;
static uint8_t allActivate = 0;
static uint8_t allDeactivate = 0;
static bool hasAutoActivationTokenBeenUsed = false;

// Log and param ids
static logVarId_t logIdStateEstimateX;
static logVarId_t logIdStateEstimateY;
static logVarId_t logIdStateEstimateZ;
static logVarId_t logIdKalmanVarPX;
static logVarId_t logIdKalmanVarPY;
static logVarId_t logIdKalmanVarPZ;
static logVarId_t logIdPmState;
static logVarId_t logIdPmVbat;
static logVarId_t logIdlighthouseEstBs0Rt;
static logVarId_t logIdlighthouseEstBs1Rt;

static paramVarId_t paramIdStabilizerController;
static paramVarId_t paramIdCommanderEnHighLevel;
static paramVarId_t paramIdLighthouseMethod;

#define USE_MELLINGER

#define TRAJ_Y_OFFSET 0.35

enum State {
  // Initialization
  STATE_IDLE = 0,
  STATE_WAIT_FOR_POSITION_LOCK,

  STATE_WAIT_FOR_TAKE_OFF, // Charging
  STATE_TAKING_OFF,
  STATE_GOING_TO_INITIAL_POSITION,
  STATE_RUNNING_TRAJECTORY,
  STATE_GOING_TO_PAD,
  STATE_WAITING_AT_PAD,
  STATE_LANDING,
  STATE_CHECK_CHARGING,
  STATE_REPOSITION_ON_PAD,
  STATE_CRASHED,
};

static enum State state = STATE_IDLE;

ledseqStep_t seq_lock_def[] = {
  { true, LEDSEQ_WAITMS(1000)},
  {    0, LEDSEQ_LOOP},
};

ledseqContext_t seq_lock = {
  .sequence = seq_lock_def,
  .led = LED_LOCK,
};

const uint8_t trajectoryId = 1;

// duration, x0-x7, y0-y7, z0-z7, yaw0-yaw7
static struct poly4d sequence[] = {
{.duration = 0.55, .p = { { 3.850187650548859e-11,-6.126680002281815e-07,0.034011535082564444,-0.00039301162214115096,-0.1361701207371884,-0.013475566231721964,0.130529177931636,-0.045789803210890365 }, { 5.130331138892934e-11,-6.894694832148174e-07,2.773646648525662e-05,0.09665022145137639,0.0030582980469091104,-0.14597702960497716,0.025898651835540337,0.031816204957023766 }, { 0.7935094937573058,0.3354737430678515,0.029057160591356115,-0.01266832414604316,-0.0005486333712972439,0.00014350768837690457,4.164379035236781e-06,-8.017606108453261e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { -6.91478839697476e-11,-0.029193709157553906,-0.10559495462082788,-0.05347086572897811,0.14298644900199997,0.13154711964858892,-0.10576667456587624,-0.004894549656081794 }, { 0.010222252124903132,0.036959027444522875,-0.008851229203278185,-0.15229948402397764,-0.10473818933972455,0.10134775456478524,0.10503082012526643,-0.06287119476974122 }, { 0.9846592732952834,0.3556417614613807,0.007402285626974173,-0.013429918473541944,-0.0001397644145837933,0.0001521442105186959,1.0560984562962911e-06,-8.232913171177211e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { -0.040192378844621866,-0.07140003156907114,0.13449310653658295,0.29378870952033365,0.009789196777066234,-0.21053548857700394,-0.05387360517952218,0.07164061867332701 }, { -7.889583206758571e-11,-0.11478801738672549,-0.20396423865608282,0.07270282032657958,0.2794859692650471,0.07498870791043256,-0.17675426222827517,0.02707614021652176 }, { 1.1802619153775327,0.3515733815370541,-0.014757042867951776,-0.013276286076733262,0.00027862940442694546,0.00015041191903359245,-2.123518122387068e-06,-7.890778247293665e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { 7.988285331714887e-11,0.250949124563496,0.28843188442817186,-0.2732723085225859,-0.397138046010713,0.019843843308082133,0.234023728053692,-0.061917114992680836 }, { -0.08786796558968518,-0.10097530219101498,0.33435181061023556,0.41521843121454044,-0.1422062400136962,-0.3066466721828446,0.019456187257606332,0.07150045317175968 }, { 1.366987423194795,0.3235458566636087,-0.03591070328290674,-0.012217896676011442,0.0006780348284016298,0.0001384300512311638,-5.159489510055758e-06,-7.004856932156779e-07 }, { -7.032049652736305e-19,2.8559933214452258,1.0578188921989469e-12,-1.0730494111436881e-11,5.356676493007769e-11,-1.41495675688421e-10,1.8919400721208388e-10,-1.0077661393087099e-10 } } },
{.duration = 0.55, .p = { { 0.14999999991104948,0.12366933349288975,-0.594807301023078,-0.5083134142516695,0.34088988322978436,0.38313148697616645,-0.10996125292105831,-0.062460250359318834 }, { 7.204168417353955e-11,0.4283978762506388,0.3532415614670374,-0.5345691196937996,-0.4879248846489399,0.1464878523984965,0.2736722525227542,-0.09725401977645685 }, { 1.5321107619678176,0.27346921634328714,-0.05461710861250694,-0.010326877829134709,0.0010312334197305668,0.00011701404859755804,-7.843326517779124e-06,-5.644608348066262e-07 }, { 1.5707963267948966,2.855993321445235,9.74588081275978e-13,-1.2504624207862248e-11,7.528531028453892e-11,-2.288999400804534e-10,3.4113546098087626e-10,-1.985970861280439e-10 } } },
{.duration = 0.55, .p = { { -5.59066431920931e-11,-0.6350414332686136,-0.39397659738533064,0.8387863079714788,0.5456595121566631,-0.29631273940846187,-0.29299785426595604,0.1306787029426239 }, { 0.2223542863477554,0.13793556474517443,-0.89810996652775,-0.5667293893725363,0.5727217708706469,0.4347776193622413,-0.2114738213220072,-0.045136085033910645 }, { 1.6643790490384371,0.20475610085841317,-0.06960144824867719,-0.007732099331413265,0.001314155199499109,8.762361080722874e-05,-9.992480186630427e-06,-3.9006659712423786e-07 }, { -3.1415926535897936,2.8559933214452955,-1.1721404849972875e-12,1.8193195687576433e-11,-1.214954249299105e-10,3.92209327554307e-10,-6.08493662478147e-10,3.6496637176493247e-10 } } },
{.duration = 0.55, .p = { { -0.2999999998502531,-0.14280177586407175,1.2235902317009941,0.5864854044133563,-0.821902942926027,-0.458065470753668,0.3170759786847334,0.02070857041926624 }, { -3.2577460605242496e-11,-0.8567973787012515,-0.40786096680328104,1.1651919747169452,0.5664074090944609,-0.45910818595856434,-0.2906835253154305,0.1599133274657139 }, { 1.7547784192264733,0.12208919547549385,-0.079842564209313,-0.0046103910307376175,0.0015075194045401598,5.226198127020738e-05,-1.1460982235188534e-05,-1.889016440196309e-07 }, { -1.570796326794896,2.8559933214452906,-6.777721171174742e-13,8.41571999341113e-12,-5.1447001812870034e-11,1.601657193261176e-10,-2.4527134121419665e-10,1.4685418151406883e-10 } } },
{.duration = 0.55, .p = { { 3.643754337176272e-12,1.0785534113363326,0.39394847289102003,-1.4915421131678,-0.5487546404671614,0.6237799510385007,0.2668869839533903,-0.18296560236848725 }, { -0.377645713358956,-0.13793634260360202,1.5490671543519818,0.5662351196084305,-1.0714521143780107,-0.45140801235888617,0.41957111218997095,-0.009157598546747017 }, { 1.7971483048456303,0.03110211318278792,-0.08464254136278623,-0.0011744922270002193,0.0015981487959421089,1.3338387806731703e-05,-1.2147884701613623e-05,2.4831049961939595e-08 }, { -7.032049652736305e-19,2.8559933214452258,1.0578188921989469e-12,-1.0730494111436881e-11,5.356676493007769e-11,-1.41495675688421e-10,1.8919400721208388e-10,-1.0077661393087099e-10 } } },
{.duration = 0.55, .p = { { 0.44999999981385413,0.1236708361999744,-1.852360020079068,-0.5073585583881348,1.3043629215048538,0.4152589392361437,-0.5119743482833228,0.04242709205047355 }, { -2.892255028914758e-11,1.285197224018973,0.35318722911573125,-1.7955965006861632,-0.493904213425741,0.7791059264537474,0.22322992441284023,-0.19826455275937296 }, { 1.7886012682105124,-0.062004526724627494,-0.08367426920180858,0.002341446292907904,0.001579866923823775,-2.6494018132335393e-05,-1.20071691427135e-05,2.3700017024090774e-07 }, { 1.5707963267948966,2.855993321445235,9.74588081275978e-13,-1.2504624207862248e-11,7.528531028453892e-11,-2.288999400804534e-10,3.4113546098087626e-10,-1.985970861280439e-10 } } },
{.duration = 0.55, .p = { { 6.290207299833442e-11,-1.4626463824098876,-0.2883550468804277,2.0566343332503036,0.40559409383419653,-0.9145009033599408,-0.16268750363951806,0.20476758074615395 }, { 0.5121320341641586,0.10097742733971936,-2.1127999212971833,-0.4138680611165395,1.5047628778036648,0.35208175066068187,-0.5879885586359589,0.07683264879591081 }, { 1.729719775743155,-0.15088566060301098,-0.07700373387507774,0.005697819139121337,0.0014539196184011809,-6.452058446859345e-05,-1.104863358878885e-05,4.3327149958112416e-07 }, { -3.1415926535897936,2.8559933214452955,-1.1721404849972875e-12,1.8193195687576433e-11,-1.214954249299105e-10,3.92209327554307e-10,-6.08493662478147e-10,3.6496637176493247e-10 } } },
{.duration = 0.55, .p = { { -0.5598076209469375,-0.07140263433406899,2.3126383091371316,0.2921348506611317,-1.6589950572984162,-0.26618186803080646,0.6424335010359736,-0.11002958730261607 }, { 9.597951350000726e-11,-1.5988080196133683,-0.20387013226299885,2.25686631394053,0.28984247050057954,-1.0207379381325101,-0.08938558710248717,0.20203151544980583 }, { 1.6245165038489418,-0.229484186061661,-0.0650855213384239,0.008665895012045418,0.0012288901901355187,-9.815048566881373e-05,-9.336680512287419e-06,5.997355942281935e-07 }, { -1.570796326794896,2.8559933214452906,-6.777721171174742e-13,8.41571999341113e-12,-5.1447001812870034e-11,1.601657193261176e-10,-2.4527134121419665e-10,1.4685418151406883e-10 } } },
{.duration = 0.55, .p = { { -1.259002816488868e-10,1.6844029450716926,0.10548999257795302,-2.382646964185611,-0.15453762518991604,1.090577152194023,0.008319579600675715,-0.19024281538440788 }, { -0.5897777477105768,-0.0369619304516594,2.4382565277146617,0.15045484415923643,-1.7565487919428409,-0.16341322608107348,0.6715988421795788,-0.1397555908106809 }, { 1.4801608816508365,-0.2924437434807816,-0.04873183808083333,0.011043404457887842,0.0009201139233646774,-0.0001250915420548524,-6.9885668510594605e-06,7.254141315649441e-07 }, { -7.032049652736305e-19,2.8559933214452258,1.0578188921989469e-12,-1.0730494111436881e-11,5.356676493007769e-11,-1.41495675688421e-10,1.8919400721208388e-10,-1.0077661393087099e-10 } } },
{.duration = 0.55, .p = { { 0.599999999844111,2.3927461238882205e-06,-2.4810939030278725,0.0015167000866790463,1.7907759559144307,0.05077933799801919,-0.6734970123796651,0.16398488137681 }, { -1.5062510312140646e-10,1.7135980060671903,-8.092823615202373e-05,-2.4254045405338003,-0.008900359502318099,1.1192591184912866,-0.07498600436508122,-0.1702048610175826 }, { 1.3064905062426948,-0.33547374306785216,-0.029057160591243466,0.012668324142701075,0.0005486333961726315,-0.00014350776673085613,-4.164265775564083e-06,8.016978543870155e-07 }, { 1.5707963267948966,2.855993321445235,9.74588081275978e-13,-1.2504624207862248e-11,7.528531028453892e-11,-2.288999400804534e-10,3.4113546098087626e-10,-1.985970861280439e-10 } } },
{.duration = 0.55, .p = { { 1.684696324300844e-10,-1.6844036074401538,0.10564814639058788,2.382225184809558,-0.13714438753235755,-1.1048292085862257,0.15485402718267108,0.1432832056601881 }, { 0.5897777477577101,-0.03695724736642449,-2.4382311387413242,0.15342317248118922,1.7593440245538934,-0.06404398289630629,-0.6479986544422184,0.1810662728655698 }, { 1.1153407267047166,-0.35564176146143944,-0.0074022856248120855,0.01342991844715964,0.00013976456430208812,-0.0001521446417983823,-1.0554850265050618e-06,8.22948076696411e-07 }, { -3.1415926535897936,2.8559933214452955,-1.1721404849972875e-12,1.8193195687576433e-11,-1.214954249299105e-10,3.92209327554307e-10,-6.08493662478147e-10,3.6496637176493247e-10 } } },
{.duration = 0.55, .p = { { -0.5598076210379912,0.07139825149091379,2.312589261409733,-0.29491239799544006,-1.6643950319008523,0.17323171666905174,0.5968414398171421,-0.18983569694044664 }, { 1.782176862162566e-10,-1.598809299210999,0.20401743042629947,2.2560514987494056,-0.2736439077732197,-1.0482707969039575,0.22584161491561602,0.11131251575246935 }, { 0.9197380846224678,-0.35157338153719797,0.014757042872100732,0.013276286030137944,-0.000278629148463537,-0.00015041264917281083,2.124556409941004e-06,7.884956572283471e-07 }, { -1.570796326794896,2.8559933214452906,-6.777721171174742e-13,8.41571999341113e-12,-5.1447001812870034e-11,1.601657193261176e-10,-2.4527134121419665e-10,1.4685418151406883e-10 } } },
{.duration = 0.55, .p = { { -1.7920474150784242e-10,1.462648192034217,-0.2884850761978434,-2.0554820105610094,0.3912959845664299,0.9534382455354368,-0.28311108050726685,-0.07647154111917422 }, { -0.5121320342929278,0.1009735221128708,2.112730557335379,-0.41634211968020773,-1.5123995951660087,0.2693429004409801,0.5235116471367357,-0.1896955312986735 }, { 0.7330125768052057,-0.3235458566636719,0.03591070328497667,0.01221789665061662,-0.0006780346842335766,-0.0001384304661573386,5.160079198788061e-06,7.001567151636996e-07 }, { -7.032049652736305e-19,2.8559933214452258,1.0578188921989469e-12,-1.0730494111436881e-11,5.356676493007769e-11,-1.41495675688421e-10,1.8919400721208388e-10,-1.0077661393087099e-10 } } },
{.duration = 0.55, .p = { { 0.4499999999715636,-0.12366755341480336,-1.852275066921324,0.5094371027073632,1.3137159519913528,-0.3458277153267635,-0.4330065813681881,0.18065532843892154 }, { -1.7136337265114753e-10,1.285199440347072,-0.3532947532369683,-1.7941851993843467,0.4820828231645054,0.8267942365837151,-0.3227596052055985,-0.041134636188990305 }, { 0.5678892380321828,-0.2734692163433205,0.054617108613167466,0.01032687782254788,-0.001031233384309226,-0.00011701414975196907,7.843470800293175e-06,5.643796521572908e-07 }, { 1.5707963267948966,2.855993321445235,9.74588081275978e-13,-1.2504624207862248e-11,7.528531028453892e-11,-2.288999400804534e-10,3.4113546098087626e-10,-1.985970861280439e-10 } } },
{.duration = 0.55, .p = { { 1.5522849496729362e-10,-1.0785558833291118,0.3940297891555278,1.4899680111047768,-0.5398174506662954,-0.6769693495801102,0.3420852069440197,0.007709953033058763 }, { 0.37764571353485776,-0.13793378466699796,-1.5489724014190445,0.5678530778528842,1.081884064224222,-0.397473847370616,-0.33149401343634677,0.16333116336928635 }, { 0.4356209509615622,-0.20475610085841497,0.06960144824921265,0.007732099322288083,-0.001314155138706674,-8.762380365769796e-05,9.992773242807845e-06,3.8989422933523954e-07 }, { -3.1415926535897936,2.8559933214452955,-1.1721404849972875e-12,1.8193195687576433e-11,-1.214954249299105e-10,3.92209327554307e-10,-6.08493662478147e-10,3.6496637176493247e-10 } } },
{.duration = 0.55, .p = { { -0.30000000003236005,0.14279999578597208,1.223492136244011,-0.5876090928765619,-0.832702892253167,0.42076169898548144,0.2258918557709576,-0.13890364859041235 }, { 1.318992184071819e-10,-0.856799937896449,0.4079141585729327,1.1635623443644554,-0.5605653476291194,-0.5141739029647922,0.3397708779069366,-0.0215246714439556 }, { 0.3452215807735272,-0.12208919547551644,0.07984256421012907,0.00461039101898122,-0.0015075193290159292,-5.226221925459312e-05,1.1461344984408984e-05,1.8868715502750348e-07 }, { -1.570796326794896,2.8559933214452906,-6.777721171174742e-13,8.41571999341113e-12,-5.1447001812870034e-11,1.601657193261176e-10,-2.4527134121419665e-10,1.4685418151406883e-10 } } },
{.duration = 0.55, .p = { { -1.0296562482478956e-10,0.6350439052613964,-0.3940016646614356,-0.8372122059048488,0.5429125789515311,0.34950213803648017,-0.3159743367738631,0.04457694648309776 }, { -0.2223542865236574,0.13793456252547456,0.8980152135934097,-0.5673588080741082,-0.5831537207912398,0.41410424056502004,0.1233967223033411,-0.10903747964749282 }, { 0.3028516951543695,-0.031102113182857404,0.08464254136521183,0.0011744921974183406,-0.0015981486270726741,-1.3338878889514318e-05,1.2148590693744128e-05,-2.5229797179643945e-08 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { 0.1500000000687585,-0.1236690561217752,-0.5947223478684789,0.5084822468775225,0.3502429135394167,-0.37795516709912697,-0.03099348668367603,0.07576798640350664 }, { -7.039927547472012e-11,0.42840009257875117,-0.35324042088607205,-0.5331578183875602,0.48806215191858937,0.19417616258916232,-0.2723172771768325,0.059875896836625954 }, { 0.31139873178948824,0.062004526724516604,0.08367426920527306,-0.002341446333445613,-0.0015798666958438464,2.6493355838210824e-05,1.2008126984933222e-05,-2.375458559854139e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { 3.64196971187048e-11,-0.2509509341878013,0.2884082386495334,0.2721199858386461,-0.3997520324157089,-0.05878118541681634,0.21177485600524693,-0.0663789245884637 }, { 0.08786796571845412,-0.10097564726160407,-0.33428244664776197,0.4149917495762834,0.14984295740213469,-0.3147779789801332,0.04502072431517355,0.041362429295659 }, { 0.37028022425684576,0.15088566060297004,0.07700373387638232,-0.005697819155841523,-0.001453919519303095,6.452029033312363e-05,1.104906078228004e-05,-4.3351409678770295e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { -0.04019237893567552,0.07140085425594368,0.134444058808306,-0.2932585391269001,0.004389222125795077,0.2288780962567252,-0.09946566658321641,-0.008165490862910199 }, { 3.3425003544920626e-12,-0.11478929698434877,0.20392332403284189,0.07188800514023376,-0.2840004090364853,0.047455849221367745,0.1384729396681704,-0.06364285941016302 }, { 0.4754834961510585,0.22948418606164786,0.06508552133959486,-0.008665895033115,-0.0012288900441894599,9.815000989805213e-05,9.337418549554038e-06,-6.001758332093377e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
{.duration = 0.55, .p = { { 2.6578192168992602e-11,0.029194371526024443,-0.10554318434787494,0.053892645106161687,0.14869556371682788,-0.11729506325296113,-0.05740693221409532,0.0518541593740201 }, { -0.010222252172035927,0.036960150373508985,0.008825840231352845,-0.15157853263092974,0.10194295680089027,0.1261094542232719,-0.12863100761173282,0.02156051258239871 }, { 0.6198391183491642,0.2924437434807964,0.04873183808147461,-0.011043404473242202,-0.0009201138107688026,0.00012509116676211315,6.989157399975058e-06,-7.257708130434234e-07 }, { 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0 } } },
};


static float sequenceTime(struct poly4d sequence[], int count) {
  float totalDuration = 0.0f;

  for (int i = 0; i < count; i++) {
    totalDuration += sequence[i].duration;
  }

  return totalDuration;
}

static float getX() { return logGetFloat(logIdStateEstimateX); }
static float getY() { return logGetFloat(logIdStateEstimateY); }
static float getZ() { return logGetFloat(logIdStateEstimateZ); }
static float getVarPX() { return logGetFloat(logIdKalmanVarPX); }
static float getVarPY() { return logGetFloat(logIdKalmanVarPY); }
static float getVarPZ() { return logGetFloat(logIdKalmanVarPZ); }
static bool isBatLow() { return logGetInt(logIdPmState) == lowPower; }
static bool isCharging() { return logGetInt(logIdPmState) == charging; }
static bool isLighthouseAvailable() { return logGetFloat(logIdlighthouseEstBs0Rt) >= 0.0f || logGetFloat(logIdlighthouseEstBs1Rt) >= 0.0f; }

#ifdef USE_MELLINGER
static void enableMellingerController() { paramSetInt(paramIdStabilizerController, ControllerTypeMellinger); }
#endif
static void enableHighlevelCommander() { paramSetInt(paramIdCommanderEnHighLevel, 1); }
// static void useCrossingBeamPositioningMethod() { paramSetInt(paramIdLighthouseMethod, 0); }
void pilotSetActivation(const uint8_t newActive) { isActive = newActive; }
void activateAll(const uint8_t isActive) {
  P2PPacket pk;

  pk.port = 0;
  pk.size = sizeof(ActivationUpdate);

  ActivationUpdate* activationUpdate = (ActivationUpdate*)&pk.data;
  activationUpdate->msgType = MSG_TYPE_ACTIVATION_UPDATE;
  activationUpdate->isActive = isActive;

  radiolinkSendP2PPacketBroadcast(&pk);

  pilotSetActivation(isActive);
}

void pilotP2PNetworkIsActive() {
  // Automatically activate if we receive P2P traffic.
  // This functionality activates a crashed and restarted CF in a running swarm.
  if (!hasAutoActivationTokenBeenUsed) {
    hasAutoActivationTokenBeenUsed = true;
    pilotSetActivation(true);

  }
}

static void defineTrajectory() {
  const uint32_t polyCount = sizeof(sequence) / sizeof(struct poly4d);
  trajectoryDurationMs = 1000 * sequenceTime(sequence, polyCount);
  crtpCommanderHighLevelWriteTrajectory(0, sizeof(sequence), (uint8_t*)sequence);
  crtpCommanderHighLevelDefineTrajectory(trajectoryId, CRTP_CHL_TRAJECTORY_TYPE_POLY4D, 0, polyCount);
}


// The flight time for one spiral sequence, that is going up in the center and down in the spiral
int getFlightCycleTimeMs() {
  return trajectoryDurationMs;
}

// The flight time from take off to the end of the last spiral
int getFullFlightTimeMs() {
  return (TAKE_OFF_TIME + DURATION_TO_INITIAL_POSITION)* 1000 + getFlightCycleTimeMs() * 2 + DURATION_TO_PAD_POSITION + LANDING_DURATION;
}

int getLandingDurationMs() {
  return LANDING_DURATION;
}

int getTakeOffDurationMs() {
  return TAKE_OFF_TIME;
}

bool isPilotReadyForFlight() {
  const float VBAT_ACCEPT_LEVEL = 4.00f;
  const float vbat = logGetFloat(logIdPmVbat);

  const bool batteryCharged = (vbat >= VBAT_ACCEPT_LEVEL);
  if (!batteryCharged) {
    DEBUG_PRINT("Battery: %fV", (double)vbat);
  }

  return (STATE_WAIT_FOR_TAKE_OFF == state) && batteryCharged && isActive;
}

void takeOffAt(const uint32_t time) {
  takeOffTime = time;
}

bool hasPilotLanded() {
  return (STATE_WAIT_FOR_TAKE_OFF == state) && (takeOffTime == 0);
}

bool hasCrashed() {
  return STATE_CRASHED == state;
}


static void defineLedSequence() {
  ledseqRegisterSequence(&seq_lock);
}

void initPilot() {
  DEBUG_PRINT("Pilot signing on\n");

  // Get log and param ids
  logIdStateEstimateX = logGetVarId("stateEstimate", "x");
  logIdStateEstimateY = logGetVarId("stateEstimate", "y");
  logIdStateEstimateZ = logGetVarId("stateEstimate", "z");
  logIdKalmanVarPX = logGetVarId("kalman", "varPX");
  logIdKalmanVarPY = logGetVarId("kalman", "varPY");
  logIdKalmanVarPZ = logGetVarId("kalman", "varPZ");
  logIdPmState = logGetVarId("pm", "state");
  logIdPmVbat = logGetVarId("pm", "vbat");
  logIdlighthouseEstBs0Rt = logGetVarId("lighthouse", "estBs0Rt");
  logIdlighthouseEstBs1Rt = logGetVarId("lighthouse", "estBs1Rt");

  paramIdStabilizerController = paramGetVarId("stabilizer", "controller");
  paramIdCommanderEnHighLevel = paramGetVarId("commander", "enHighLevel");
  paramIdLighthouseMethod = paramGetVarId("lighthouse", "method");



  #ifdef USE_MELLINGER
    enableMellingerController();
  #endif

  // useCrossingBeamPositioningMethod();
  enableHighlevelCommander();
  defineTrajectory();
  defineLedSequence();
  resetPositionLockData();

  // Hack to work around bug in high level commander
  setpoint_t setpoint = {0};
  commanderSetSetpoint(&setpoint, 3);
}

void pilotTimerCb(xTimerHandle timer) {
  uint32_t previous = now;
  now = xTaskGetTickCount();
  uint32_t delta = now - previous;

  if(supervisorIsTumbled()) {
    state = STATE_CRASHED;
  }

  if (isBatLow()) {
    terminateTrajectoryAndLand = true;
  }

  if (allActivate) {
    allActivate = 0;
    activateAll(1);
  }

  if (allDeactivate) {
    allDeactivate = 0;
    activateAll(0);
  }

  switch(state) {
    case STATE_IDLE:
      DEBUG_PRINT("I'm ready! Waiting for position lock...\n");
      state = STATE_WAIT_FOR_POSITION_LOCK;
      break;
    case STATE_WAIT_FOR_POSITION_LOCK:
      if (hasPositionLock()) {
        DEBUG_PRINT("Position lock acquired, ready for take off..\n");
        ledseqRun(&seq_lock);
        state = STATE_WAIT_FOR_TAKE_OFF;
      }
      break;
    case STATE_WAIT_FOR_TAKE_OFF:
      trajectoryStartTime = 0;
      if (takeOffTime != 0 && takeOffTime <= now && isActive) {
        takeOffTime = 0;
        DEBUG_PRINT("Taking off!\n");

        padX = getX();
        padY = getY();
        padZ = getZ();
        DEBUG_PRINT("Pad position: (%f, %f, %f)\n", (double)padX, (double)padY, (double)padZ);

        terminateTrajectoryAndLand = false;
        crtpCommanderHighLevelTakeoff(padZ + TAKE_OFF_HEIGHT, TAKE_OFF_TIME);
        state = STATE_TAKING_OFF;
      }
      break;
    case STATE_TAKING_OFF:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Going to initial position, will be there in T -%f s\n", (double)(DURATION_TO_INITIAL_POSITION));
        crtpCommanderHighLevelGoTo(sequence[0].p[0][0] + trajecory_center_offset_x, sequence[0].p[1][0] + trajecory_center_offset_y, sequence[0].p[2][0] + trajecory_center_offset_z, sequence[0].p[3][0], DURATION_TO_INITIAL_POSITION, false);
        ledseqStop(&seq_lock);
        state = STATE_GOING_TO_INITIAL_POSITION;
      }
      flightTime += delta;
      break;
    case STATE_GOING_TO_INITIAL_POSITION:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("At initial position, starting trajectory\n");
        trajectoryStartTime = now;
        crtpCommanderHighLevelStartTrajectory(trajectoryId, SEQUENCE_SPEED, true, false);
        remainingTrajectories = trajectoryCount - 1;
        state = STATE_RUNNING_TRAJECTORY;
      }
      flightTime += delta;
      break;
    case STATE_RUNNING_TRAJECTORY:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        if (terminateTrajectoryAndLand || (remainingTrajectories == 0) || !isActive) {
          terminateTrajectoryAndLand = false;
          DEBUG_PRINT("Terminating trajectory, going back to pad\n");
          crtpCommanderHighLevelGoTo(padX, padY, padZ + LANDING_HEIGHT, 0.0, DURATION_TO_PAD_POSITION, false);
          state = STATE_GOING_TO_PAD;
        } else {
          if (remainingTrajectories > 0) {
            DEBUG_PRINT("Trajectory finished, running one more time\n");
            crtpCommanderHighLevelStartTrajectory(trajectoryId, SEQUENCE_SPEED, true, false);
          }
          remainingTrajectories--;
        }
      }
      flightTime += delta;
      break;
    case STATE_GOING_TO_PAD:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Over pad, stabilizing position\n");
        stabilizeEndTime = now + 5000;
        state = STATE_WAITING_AT_PAD;
      }
      flightTime += delta;
      break;
    case STATE_WAITING_AT_PAD:
      if (now > stabilizeEndTime || ((fabs(padX - getX()) < MAX_PAD_ERR) && (fabs(padY - getY()) < MAX_PAD_ERR))) {
        if (now > stabilizeEndTime) {
          DEBUG_PRINT("Warning: failed to stabilize in time!\n");
        }

        DEBUG_PRINT("Landing...\n");
        crtpCommanderHighLevelLand(padZ, LANDING_DURATION);
        state = STATE_LANDING;
      }
      flightTime += delta;
      break;
    case STATE_LANDING:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Landed. Re-charge me!\n");
        crtpCommanderHighLevelStop();
        landingTimeCheckCharge = now + 3000;
        state = STATE_CHECK_CHARGING;
      }
      flightTime += delta;
      break;
    case STATE_CHECK_CHARGING:
      if (now > landingTimeCheckCharge) {
        if (isCharging()) {
          DEBUG_PRINT("Charging started");
          ledseqRun(&seq_lock);
          state = STATE_WAIT_FOR_TAKE_OFF;
        } else {
          DEBUG_PRINT("Not charging. Try to reposition on pad.\n");
          crtpCommanderHighLevelTakeoff(padZ + LANDING_HEIGHT, 1.0);
          state = STATE_REPOSITION_ON_PAD;
        }
      }
      break;
    case STATE_REPOSITION_ON_PAD:
      if (crtpCommanderHighLevelIsTrajectoryFinished()) {
        DEBUG_PRINT("Over pad, stabilizing position\n");
        crtpCommanderHighLevelGoTo(padX, padY, padZ + LANDING_HEIGHT, 0.0, 1.5, false);
        state = STATE_GOING_TO_PAD;
      }
      flightTime += delta;
      break;
    case STATE_CRASHED:
      crtpCommanderHighLevelStop();
      break;
    default:
      break;
  }
}


static bool hasPositionLock() {
  bool result = false;

  // Store current state
  positionLockData[positionLockWriteIndex][0] = getVarPX();
  positionLockData[positionLockWriteIndex][1] = getVarPY();
  positionLockData[positionLockWriteIndex][2] = getVarPZ();

  positionLockWriteIndex++;
  if (positionLockWriteIndex >= LOCK_LENGTH) {
    positionLockWriteIndex = 0;
  }

  // Check if we have a lock
  int count = 0;

  float lXMax = FLT_MIN;
  float lYMax = FLT_MIN;
  float lZMax = FLT_MIN;

  float lXMin = FLT_MAX;
  float lYMin = FLT_MAX;
  float lZMin = FLT_MAX;

  for (int i = 0; i < LOCK_LENGTH; i++) {
    if (positionLockData[i][0] != FLT_MAX) {
      count++;

      lXMax = fmaxf(lXMax, positionLockData[i][0]);
      lYMax = fmaxf(lYMax, positionLockData[i][1]);
      lZMax = fmaxf(lZMax, positionLockData[i][2]);

      lXMin = fminf(lXMax, positionLockData[i][0]);
      lYMin = fminf(lYMin, positionLockData[i][1]);
      lZMin = fminf(lZMin, positionLockData[i][2]);
    }
  }

  result =
    (count >= LOCK_LENGTH) &&
    ((lXMax - lXMin) < LOCK_THRESHOLD) &&
    ((lYMax - lYMin) < LOCK_THRESHOLD) &&
    ((lZMax - lZMin) < LOCK_THRESHOLD &&
    isLighthouseAvailable() &&  // Make sure we have a deck and the Lighthouses are powered
    sensorsAreCalibrated());

  return result;
}

static void resetPositionLockData() {
    positionLockWriteIndex = 0;
    for (uint32_t i = 0; i < LOCK_LENGTH; i++) {
      positionLockData[i][0] = FLT_MAX;
      positionLockData[i][1] = FLT_MAX;
      positionLockData[i][2] = FLT_MAX;
    }
}

PARAM_GROUP_START(app)
  PARAM_ADD(PARAM_UINT8, stop, &terminateTrajectoryAndLand)
  PARAM_ADD(PARAM_FLOAT, offsx, &trajecory_center_offset_x)
  PARAM_ADD(PARAM_FLOAT, offsy, &trajecory_center_offset_y)
  PARAM_ADD(PARAM_FLOAT, offsz, &trajecory_center_offset_z)
  PARAM_ADD(PARAM_UINT8, trajcount, &trajectoryCount)
  PARAM_ADD(PARAM_UINT8, active, &isActive)
  PARAM_ADD(PARAM_UINT8, activeAll, &allActivate)
  PARAM_ADD(PARAM_UINT8, deactiveAll, &allDeactivate)
PARAM_GROUP_STOP(app)

LOG_GROUP_START(app)
  LOG_ADD(LOG_UINT8, state, &state)
  LOG_ADD(LOG_UINT32, uptime, &now)
  LOG_ADD(LOG_UINT32, flighttime, &flightTime)
LOG_GROUP_STOP(app)
